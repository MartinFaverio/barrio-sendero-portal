<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapa de Proveedores</title>

    <!-- Bootstrap + Icons + Leaflet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Estilos compartidos -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/listar_proveedores.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mapa_proveedores.css') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
</head>

<body style="padding-top: 70px;">
    {% include 'navbar.html' %}

    <div class="container mt-4">
        <!-- Cartel de bienvenida -->
        <div class="bienvenida text-center mb-4">
            <h1><i class="bi bi-geo-alt-fill me-2 text-danger"></i>Mapa de Proveedores</h1>
            <p>Filtrá los servicios disponibles en el barrio</p>
        </div>

        <!-- Filtros -->
        <form id="filtros" class="row g-3 mb-4">
            <div class="col-md-4">
                <select id="filtro-rubro" class="form-select">
                    <option value="">Todos los rubros</option>
                    {% for rubro in rubros %}
                    <option value="{{ rubro }}">{{ rubro }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 form-check">
                <input class="form-check-input" type="checkbox" id="filtro-emergencia">
                <label class="form-check-label" for="filtro-emergencia">Solo emergencias</label>
            </div>
            <div class="col-md-4 form-check">
                <input class="form-check-input" type="checkbox" id="filtro-24hs">
                <label class="form-check-label" for="filtro-24hs">Solo atención 24hs</label>
            </div>
        </form>

        <!-- Mapa -->
        <div id="map"></div>

        <!-- Leyenda -->
        <div class="text-center mt-3">
            <span class="badge bg-primary me-2"><i class="bi bi-wrench-adjustable-circle me-1"></i>Servicio
                general</span>
            <span class="badge bg-danger me-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>Emergencia</span>
            <span class="badge bg-warning text-dark"><i class="bi bi-clock-history me-1"></i>24hs</span>
        </div>
    </div>

    <footer class="mt-5">
        <i class="bi bi-map-fill"></i>Portal Barrio Sendero – Mapa interactivo de proveedores
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([-34.39902, -58.65293], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var proveedores = {{ proveedores | tojson | safe }};
        var urlBase = "/proveedores/proveedor/";
        var markers = [];

        function renderMapa() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            var rubro = document.getElementById("filtro-rubro").value;
            var emergencia = document.getElementById("filtro-emergencia").checked;
            var atencion24 = document.getElementById("filtro-24hs").checked;

            proveedores.forEach(function (p) {
                if (!p.latitud || !p.longitud) return;
                if (rubro && p.rubro !== rubro) return;
                if (emergencia && !p.emergencia) return;
                if (atencion24 && !p.atencion_24hs) return;

                var popupContent = `
                    <strong><i class="bi ${p.icono} ${p.color} me-1"></i>${p.nombre}</strong><br>
                    ${p.direccion || ''}<br>
                    <a href="${urlBase + p.id}"><i class="bi bi-eye-fill me-1"></i>Ver perfil</a>
                `;

                var marker = L.marker([p.latitud, p.longitud])
                    .addTo(map)
                    .bindPopup(popupContent);

                marker.on('mouseover', function () {
                    this.openPopup();
                });

                markers.push(marker);
            });
        }

        document.getElementById("filtros").addEventListener("change", renderMapa);
        renderMapa();
    </script>
</body>

</html>